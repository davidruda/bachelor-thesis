\chapter{User guide} \label{chap:user_guide}

This guide is intended for users interested in running the code associated with this thesis. It is logically divided into two parts:
\begin{itemize}
    \item \textbf{Simulator} - a standalone tool for evaluating the Traffic signaling problem (described in Chapter~\ref{chap:problem_description}) with various handy features, wrapped into the \verb|traffic-signaling| Python package
    \item \textbf{Optimization and experiments} - scripts for running the optimization and experiments, which use the simulator
\end{itemize}

\section{Prerequisites}

When listing version requirements for the tools below, we specify the \textit{minimum} supported version. As of July 2025, the latest available versions (e.g., Python 3.13) are also compatible. However, we cannot guarantee compatibility with all future versions.

\bigskip

To build and install the \verb|traffic-signaling| package, you need:
\begin{itemize}
    \item \textbf{C++ compiler} with C++20 code support; e.g., gcc 11, clang 16, or MSVC 19.29 (or later versions)
    \item \textbf{Python} 3.10 or later
    \item \textbf{Python headers} (most likely already installed with Python)
    \begin{itemize}
        \item You can verify that the headers are available by inspecting their expected location with e.g.
\begin{verbatim}
    python3 -c "import sysconfig;
        print(sysconfig.get_path('include'))"
\end{verbatim}
        \item If not available, install the headers with e.g.
\begin{verbatim}
    sudo apt install python3-dev
\end{verbatim}
    \end{itemize}
\end{itemize}
To easily set up the environment for optimization and run the experiments, you further need:
\begin{itemize}
    \item \textbf{GNU Make}
\end{itemize}
Optionally, if you want to run all unit tests for both C++ and Python, you additionally need:
\begin{itemize}
    \item \textbf{Git}
    \item \textbf{CMake} 3.24 or later
\end{itemize}

\newpage

\section{Simulator}

\textbf{If you only want to run the optimization and do not want to use the simulator as a standalone tool, feel free to skip this section.}

\bigskip

After satisfying the prerequisites, you can simply build and install \\
the \verb|traffic-signaling| Python package by running the following command in the top-level directory:
\begin{verbatim}
    pip install ./traffic_signaling
\end{verbatim}
This will install the package into your Python environment (preferably into a virtual environment), making it available for use in your Python scripts.

\bigskip

To run Python unit tests for the package using Python's \verb|unittest| built-in framework, use the following command:
\begin{verbatim}
    make test_package_python
\end{verbatim}
To run both C++ and Python unit tests using CMake, use the following command:
\begin{verbatim}
    make test_package_cmake
\end{verbatim}
Note that running the make commands will create a virtual environment \verb|.venv| and install all required packages there using pip.

\subsection{Code example}

The following code snippet demonstrates some of the package's functionality. 
For the full API reference, see the \verb|traffic_signaling/traffic_signaling| subdirectory, which contains the files \verb|city_plan.pyi|, \verb|simulation.pyi|, and \verb|utils.py|. These files include extensive docstrings for every class and method, effectively serving as the package documentation.

\begin{lstlisting}[language=Python]
from traffic_signaling import *

# Load the city plan for a specific dataset
plan = create_city_plan(data='e')
# Create a simulation for the given city plan
sim = Simulation(plan)

# Initialize the traffic light schedules
sim.create_schedules(order='default', times='default')
# Save the schedules to a file in the competition format
sim.save_schedules('schedules.txt')
# Load the schedules from a file
sim.load_schedules('schedules.txt')

# Calculate the score
score = sim.score()
# Show a summary report of the simulation
sim.summary()
\end{lstlisting}

\bigskip

\section{Optimization} \label{sec:optimization}

\textbf{To quickly set up the environment for optimization, run the following command in the top-level directory:}
\begin{verbatim}
    make setup
\end{verbatim}
This will create a virtual environment \verb|.venv|, build and install the simulator and other necessary packages using pip into it, and compile \verb|operators.py| file using Cython\footnote{\url{https://cython.org/}} for better performance during optimization. Do not forget to activate the virtual environment before running any scripts with e.g.
\begin{verbatim}
    source .venv/bin/activate
\end{verbatim}
If you encounter any issues, try running \verb|make clean| and then \verb|make setup| again.

Now you can run the optimization algorithms using the \verb|optimizer.py| script. The script has two required positional arguments:
\begin{itemize}
    \item \verb|algorithm| - algorithm to use for optimization; possible values are \verb|ga|, \verb|hc|, \verb|sa|
    \item \verb|data| - input dataset to use; possible values are \verb|a|, \verb|b|, \verb|c|, \verb|d|, \verb|e|, \verb|f|
\end{itemize}
After specifying the required arguments, you can easily run the script with e.g.:
\begin{verbatim}
    python3 optimizer.py hc e
\end{verbatim}
This will run the Hill Climbing algorithm on dataset E using default values. However, you probably want to explicitly set some parameters, especially the hyperparameter values. If you prefer, you can run
\begin{verbatim}
    python3 optimizer.py --help
\end{verbatim}
to see the full usage. Below is a concise list of the parameters:
\begin{itemize}
    \item \verb|--order_init| - \textit{order initialization} hyperparameter; possible values are \verb|adaptive|, \verb|random|, \verb|default|
    \item \verb|--times_init| - \textit{times initialization} hyperparameter; possible values are \verb|scaled|, \verb|default|
    \item \verb|--mutation_bit_rate| - \textit{mutation bit rate} hyperparameter
    \item \verb|--population| - \textit{population size} hyperparameter (GA only)
    \item \verb|--generations| - \textit{generations} hyperparameter (GA only)
    \item \verb|--crossover| - \textit{crossover probability} hyperparameter (GA only)
    \item \verb|--mutation| - \textit{mutation probability} hyperparameter (GA only)
    \item \verb|--elitism| - \textit{elitism} hyperparameter (GA only)
    \item \verb|--tournsize| - \textit{tournament size} hyperparameter (GA only)
    \item \verb|--iterations| - \textit{iterations} hyperparameter (HC and SA)
    \item \verb|--temperature| - \textit{initial temperature} hyperparameter (SA only)
    \item \verb|--seed| - value of the random seed for reproducibility
    \item \verb|--threads| - number of threads for parallel evaluation
    \item \verb|--logdir| - custom name of the directory with results and logs
    \item \verb|--verbose| - whether to print detailed output during optimization
    \item \verb|--no-save| - skip saving results to the log directory
\end{itemize}
An example of running the script with more parameters could look like this:
\begin{verbatim}
    python3 optimizer.py ga e \
        --order_init random --times_init scaled \
        --mutation_bit_rate 5 --population 100 --generations 200 \
        --threads 16 --seed 21 --verbose
\end{verbatim}
When the optimization finishes (and if the \verb|--no-save| option was not used), the optimizer will save the following files in the log directory:
\begin{itemize}
    \item a CSV file containing statistics for each iteration / generation of the algorithm
    \item a file with the best schedules found, stored in the competition format
    \item a PDF file visualizing the optimization process
    \item an information file listing all parameters, their values, and additional details
\end{itemize}

\bigskip

Optionally, you can run unit tests for the optimizer with the following command:
\begin{verbatim}
    make test_optimizer
\end{verbatim}

\subsection{Running the experiments}

To replicate the experiments presented in this thesis, ensure that you have already run the \verb|make setup| command, then navigate to the \verb|experiments| directory. We recommend reading the \verb|experiments/README.md| file for more details, but for convenience, we also include the list of commands below. We strongly suggest running each algorithm and dataset separately.
\begin{itemize}
    \item \verb|make test| - run a simple sanity check experiment
    \item \verb|make init_experiment| - run a quick experiment comparing different initialization methods
    \item \verb|make run_{b,c,d,e,f}_{ga,hc,sa}| - run a specific algorithm on a specific dataset (using 10 runs with different fixed seeds)
    \item \verb|make run_{b,c,d,e,f}| - run all algorithms on a specific dataset
    \item \verb|make plot_{b,c,d,e,f}| - plot the results of a specific dataset
    \item \verb|make plots| - plot all datasets
    \item \verb|make all| - run everything and plot all results
\end{itemize}

The schedules corresponding to the best scores
achieved for each dataset during optimization are stored in the \verb|experiments/best_solutions| directory.
